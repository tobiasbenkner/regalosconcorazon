<style>

    .image-grid-title {
        font-size: 3rem;
        margin-bottom: 50px;
        border-bottom: 1px solid var(--gray);
    }
    .image-grid-container {
        display: grid;
        gap: 50px;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        /*grid-auto-rows: 300px;*/
        margin-bottom: 100px;
    }

    @media screen and (max-width: 990px) {
        .image-grid-container {
            grid-template-columns: 1fr 1fr;
        }
    }

    .image-grid-item {
        display: flex;
        flex-direction: column;
    }

    .image-grid-item > h4 {
        font-weight: bold;
    }

    .image-grid-item > img {
        object-fit: cover;
        border: 1px solid var(--gray);
        width: 100%;
        height: 300px;
        border-radius: 20px;
    }

</style>

<div class="page-width">

    {%- liquid
        render 'snackbar'
    -%}

    {% for block in section.blocks %}
        {%- assign collection = collections[block.settings.collection] -%}
        {% if collections[collection.handle].products.size > 0 %}
            <h1 class="image-grid-title">{{block.settings.title}}</h1>
            <div class="image-grid-container">
                {% for product in collections[collection.handle].products %}
                    <div class="image-grid-item">
                        <img src="{{ product.images[0].src | image_url: width: 500 }}"
                             alt="{{ product.title }}"
                        />
                        <h4 class="center" style="margin-bottom: 0; margin-top: 10px; font-weight: bold">{{ product.title }}</h4>
                        {% if section.settings.price %}
                            <div class="center">{{ product.variants[0].price | money }}</div>
                        {% endif %}

                        {% if section.settings.chart %}
                            <button id="buy-{{ product.variants.first.id }}"
                                    class="button button--secondary"
                                    style="display: flex; justify-content: center"
                                    onclick="addToChart('{{ product.variants.first.id }}', '{{ product.title }}')"
                            >
                                {% render 'icon-cart' %}
                                Añadir
                            </button>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {%- endfor -%}
</div>

<script>
    const addToChart = async (productId, title) => {
        const buyButton = document.getElementById(`buy-${productId}`);
        buyButton.disabled = true;

        try {
            const payload = {
                items: [{
                    id: productId,
                    quantity: 1,
                }]
            };

            const rawResponse = await fetch('/cart/add.js', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload),
            });

            const content = await rawResponse.json();
            showSnackbar(`${title} ha sido añadido al carrito.`);
            console.log(content);

        } catch (e) {
            showSnackbar(`Error`);
        } finally {
            buyButton.disabled = false;
        }
    };
</script>

{% schema %}
  {
    "name": "custom-collection-list",
    "settings": [
    {
      "type": "checkbox",
      "id": "price",
      "label": "Show price",
      "default": true
    },
    {
        "type": "checkbox",
        "id": "chart",
        "label": "Show cart",
        "default": false
    }
  	],
	"blocks": [
        {
          "type": "collection",
          "name": "Collection",
          "settings": [
            {
              "label": "Title",
              "id": "title",
              "type": "text",
              "default": "Title"
            },
            {
              "label": "Collection",
              "id": "collection",
              "type": "collection"
            }
          ]
        }
      ],
    "presets": [
      {
        "name": "Custom Collection List"
      }
    ]
  }
{% endschema %}

{% stylesheet %}
{% endstylesheet %}

{% javascript %}
{% endjavascript %}
